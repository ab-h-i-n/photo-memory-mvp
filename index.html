<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MagicFrame AR</title>

  <!-- Three.js + MindAR -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image-three.prod.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image.prod.css"/>

  <meta name="viewport" content="width=device-width,initial-scale=1.0">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { 
      margin: 0; 
      height: 100%; 
      width: 100%;
      overflow: hidden; 
      background: black; 
    }
    #ar-container {
      width: 100vw; 
      height: 100vh;
      position: relative;
      overflow: hidden;
    }
    /* Make sure MindAR's video is visible */
    #ar-container > video,
    .mindar-ui-overlay video,
    video[autoplay] {
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
      object-fit: cover !important;
      z-index: 1 !important;
      display: block !important;
      visibility: visible !important;
    }
    #ar-container canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
    }
    /* Hide only our texture video */
    #ar-video {
      display: none !important;
    }
    #err {
      position: absolute; 
      top: 50%; 
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0);
      padding: 12px 18px; 
      border-radius: 10px;
      color: white; 
      font-size: 15px; 
      display: none;
      z-index: 999;
    }
  </style>
</head>
<body>

<div id="ar-container"></div>
<div id="err"></div>

<!-- Hidden video (used as texture) -->
<video id="ar-video"
  src="./your-video.mp4"
  preload="auto"
  playsinline
  webkit-playsinline
  loop
  crossorigin="anonymous"
></video>

<script>
(async () => {

  const MIND_FILE = "./your-target.mind";   // <--- UPDATE THIS
  const VIDEO_ID  = "ar-video";
  const container = document.getElementById("ar-container");
  const errBox    = document.getElementById("err");

  function showError(msg) {
    errBox.style.display = "block";
    errBox.innerText = msg;
    console.error("AR ERROR:", msg);
  }

  // STEP 1 — Initialize AR (MindAR will handle camera permissions)
  try {

    const mindarThree = new window.MINDAR.IMAGE.MindARThree({
      container: container,
      imageTargetSrc: MIND_FILE,
      maxTrack: 1,
      filterMinCF: 0.001,      // Balanced for smooth tracking
      filterBeta: 1000,        // Very high for instant response
      warmupTolerance: 1,      // Minimum for fastest detection
      missTolerance: 1,        // Minimum for fastest response
      uiLoading: "no",
      uiError: "no"
    });

    const { renderer, scene, camera } = mindarThree;

    // Performance optimizations for low-end devices
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5)); // Limit pixel ratio
    renderer.powerPreference = "high-performance";
    
    // Enable alpha on renderer for transparency
    renderer.setClearColor(0x000000, 0);
    renderer.domElement.style.background = "transparent";
    
    // Make sure renderer is properly sized and visible
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.domElement.style.position = "absolute";
    renderer.domElement.style.top = "0";
    renderer.domElement.style.left = "0";
    renderer.domElement.style.width = "100%";
    renderer.domElement.style.height = "100%";
    renderer.domElement.style.zIndex = "2";
    
    container.appendChild(renderer.domElement);
    
    // Handle window resize
    window.addEventListener('resize', () => {
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
    });

    // STEP 2 — Setup video texture
    const video = document.getElementById(VIDEO_ID);
    video.muted = true;   // Start muted
    video.volume = 1.0;   // Set volume to 100%
    video.autoplay = false; // Don't autoplay - only play on target detection
    video.loop = true;
    video.playsInline = true;
    
    // Reduce video quality for better performance on low-end devices
    if (video.videoWidth > 1280) {
      video.style.maxWidth = '1280px';
    }

    // Wait for video to be ready
    await new Promise((resolve) => {
      if (video.readyState >= 2) {
        resolve();
      } else {
        video.addEventListener('loadedmetadata', resolve, { once: true });
      }
    });

    // Don't play video initially - wait for target detection
    // Just prepare the texture
    const texture = new THREE.VideoTexture(video);
    texture.minFilter = THREE.LinearFilter;  // Performance optimization
    texture.magFilter = THREE.LinearFilter;  // Performance optimization
    texture.generateMipmaps = false;         // Disable mipmaps for performance
    
    const aspect = video.videoWidth / video.videoHeight;
    const geometry = new THREE.PlaneGeometry(aspect, 1);
    const material = new THREE.MeshBasicMaterial({ 
      map: texture,
      side: THREE.DoubleSide  // Ensure visibility from both sides
    });
    const mesh = new THREE.Mesh(geometry, material);

    const anchor = mindarThree.addAnchor(0);
    anchor.group.add(mesh);

    let isPlaying = false;
    let lastPlayTime = 0;
    const playDebounce = 100; // Prevent rapid toggling

    anchor.onTargetFound = () => {
      const now = Date.now();
      if (!isPlaying && now - lastPlayTime > playDebounce) {
        console.log("Target found - playing video with sound");
        video.currentTime = 0;  // Start from beginning
        video.muted = false;    // Unmute when target found (user interaction)
        video.play().catch(err => {
          console.log("Play error:", err);
          // If unmuted play fails, try muted
          video.muted = true;
          video.play();
        });
        isPlaying = true;
        lastPlayTime = now;
      }
    };
    anchor.onTargetLost  = () => {
      const now = Date.now();
      if (isPlaying && now - lastPlayTime > playDebounce) {
        console.log("Target lost - pausing video");
        video.pause();
        video.muted = true;      // Mute when paused
        video.currentTime = 0;   // Reset to beginning
        isPlaying = false;
        lastPlayTime = now;
      }
    };

    // START AR
    await mindarThree.start();
    
    console.log("AR started successfully");
    
    // Force camera video to be visible
    setTimeout(() => {
      const cameraVideo = container.querySelector('video:not(#ar-video)');
      if (cameraVideo) {
        cameraVideo.style.display = 'block';
        cameraVideo.style.visibility = 'visible';
        cameraVideo.style.zIndex = '1';
        console.log("Camera video found and made visible");
      } else {
        console.log("Camera video not found");
      }
    }, 100);
    
    // Optimized render loop
    let lastTime = 0;
    const targetFPS = 'ontouchstart' in window ? 30 : 60; // 30 FPS on mobile, 60 on desktop
    const frameInterval = 1000 / targetFPS;
    
    renderer.setAnimationLoop((time) => {
      const delta = time - lastTime;
      if (delta >= frameInterval) {
        renderer.render(scene, camera);
        lastTime = time - (delta % frameInterval); // Maintain frame timing
      }
    });

  } catch (e) {
    console.error("AR INIT ERROR:", e);
    showError("Initialization failed. Please enable camera access and reload.");
  }

})();
</script>

</body>
</html>
